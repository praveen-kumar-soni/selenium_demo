version: 2.1

orbs:
  browser-tools: circleci/browser-tools@2.3.1

jobs:
  test:
    docker:
      - image: cimg/python:3.11
      - image: cimg/node:20.4.0-browsers
    steps:
      - checkout
      - browser-tools/install_browser_tools
      - run:
          name: Install Java (Required for Allure)
          command: |
            sudo apt-get update
            sudo apt-get install default-jre
      - run:
          name: Install dependencies
          command: |
            pip install selenium pytest allure-pytest pytest-xdist
            wget https://github.com/allure-framework/allure2/releases/download/2.27.0/allure-2.27.0.tgz
            tar -xzf allure-2.27.0.tgz
            sudo mv allure-2.27.0 /opt/allure
            sudo ln -s /opt/allure/bin/allure /usr/bin/allure
      - run:
          name: Run Selenium Grid test with Allure
          command: pytest -v -n 2 test_grid_demo.py --alluredir=allure-results
      - run:
          when: always
          name: Generate Allure Report
          command: allure generate allure-results --clean -o allure-report
      - store_artifacts:
          when: always
          path: allure-report
          destination: allure-report

workflows:
  test-workflow:
    jobs:
      - test