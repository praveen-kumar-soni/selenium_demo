version: 2.1

executors:
  python-selenium-grid:
    docker:
      - image: cimg/python:3.11
      - image: selenium/standalone-chrome:latest
        name: selenium-hub
        environment:
          SE_NODE_MAX_SESSIONS: 3
          SE_NODE_SESSION_TIMEOUT: 300
          SE_START_XVFB: true

jobs:
  test:
    executor: python-selenium-grid
    steps:
      - checkout
            # Install Java, required for allure-commandline
      - run:
          name: Install Java (Required for Allure)
          command: |
            sudo apt-get update
            sudo apt-get install default-jre
      - run:
          name: Install dependencies
          command: |
            pip install selenium pytest allure-pytest pytest-xdist
            wget https://github.com/allure-framework/allure2/releases/download/2.27.0/allure-2.27.0.tgz
            tar -xzf allure-2.27.0.tgz
            sudo mv allure-2.27.0 /opt/allure
            sudo ln -s /opt/allure/bin/allure /usr/bin/allure
      - run:
          name: Run Selenium Grid test with Allure
          command: pytest test_grid_demo.py --alluredir=allure-results
      - run:
          name: Generate Allure Report
          command: allure generate allure-results --clean -o allure-report
      - store_artifacts:
          path: allure-report
          destination: allure-report

workflows:
  test-workflow:
    jobs:
      - test